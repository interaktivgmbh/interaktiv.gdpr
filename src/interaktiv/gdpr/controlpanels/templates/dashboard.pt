<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      lang="en"
   metal:use-macro="context/main_template/macros/master"
   i18n:domain="interaktiv.gdpr">
<body>

<metal:title fill-slot="content-title">
  <a id="setup-link"
     class="link-parent"
     href="${portal_url}/@@overview-controlpanel" i18n:translate="" i18n:domain="zope">Configuration</a>
  <h1 class="documentFirstHeading" i18n:translate="Interaktiv GDPR: Deletion Info">Interaktiv GDPR: Deletion Info</h1>
</metal:title>

<metal:content-core fill-slot="content-core"
   tal:define="feature_enabled view/is_feature_enabled;
    pending_count view/get_pending_count;
      display_days view/get_display_days">

  <style>
    .gdpr-section {
      margin-bottom: 2rem;
    }

    .gdpr-section h2 {
      margin-bottom: 1rem;
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.5rem;
    }

    .status-pending {
      color: #856404;
      background-color: #fff3cd;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .status-deleted {
      color: #721c24;
      background-color: #f8d7da;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .status-withdrawn {
      color: #155724;
      background-color: #d4edda;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .btn-withdraw {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #212529;
    }

    .btn-withdraw:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }

    .btn-delete {
      background-color: #dc3545;
      border-color: #dc3545;
      color: #fff;
    }

    .btn-delete:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      pointer-events: none;
    }

    .modal-backdrop.active {
      display: block;
      pointer-events: auto;
    }

    .modal-dialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 2rem;
      border-radius: 8px;
      z-index: 10001;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      display: none;
      pointer-events: none;
    }

    .modal-dialog.active {
      display: block;
      pointer-events: auto;
    }

    .modal-header {
      margin-bottom: 1rem;
    }

    .modal-header h3 {
      margin: 0;
      color: #856404;
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .modal-error {
      background-color: #f8d7da;
      color: #721c24;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .modal-success {
      background-color: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .modal-warning {
      background-color: #fff3cd;
      color: #856404;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .settings-section {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      border: 1px solid #dee2e6;
    }

    .settings-section h2 {
      margin-top: 0;
      border-bottom: none;
    }

    .radio-group {
      display: flex;
      gap: 2rem;
      margin-top: 1rem;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      border: 2px solid transparent;
    }

    .radio-group label:hover {
      background: #e9ecef;
    }

    .radio-group label.selected {
      border-color: #007bff;
      background: #e7f1ff;
    }

    .radio-group input[type="radio"] {
      width: 18px;
      height: 18px;
    }

    .feature-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      margin-left: 1rem;
    }

    .feature-status.enabled {
      background: #d4edda;
      color: #155724;
    }

    .feature-status.disabled {
      background: #f8d7da;
      color: #721c24;
    }

    .info-text {
      color: #6c757d;
      font-size: 0.9em;
      margin-top: 0.5rem;
    }
  </style>

  <!-- Withdraw Confirmation Modal -->
  <div id="withdraw-modal-backdrop" class="modal-backdrop"></div>
  <div id="withdraw-modal" class="modal-dialog">
    <div class="modal-header">
      <h3 i18n:translate="modal_are_you_sure">Are you sure?</h3>
    </div>
    <div class="modal-body">
      <p i18n:translate="modal_withdraw_question">Are you sure you want to withdraw the deletion?</p>
      <p><strong i18n:translate="label_title">Title:</strong> <span id="modal-title"></span></p>
      <p><strong i18n:translate="label_original_path">Original Path:</strong> <span id="modal-path"></span></p>
      <p i18n:translate="modal_withdraw_info">The content will be moved back to its original location.</p>
    </div>
    <div id="modal-message"></div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeModal('withdraw')" i18n:translate="button_cancel">Cancel</button>
      <button type="button" class="btn btn-primary" id="modal-confirm-btn" onclick="confirmWithdraw()" i18n:translate="button_withdraw">Withdraw</button>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="delete-modal-backdrop" class="modal-backdrop"></div>
  <div id="delete-modal" class="modal-dialog">
    <div class="modal-header">
      <h3 style="color: #721c24;" i18n:translate="modal_delete_permanently">Delete permanently?</h3>
    </div>
    <div class="modal-body">
      <div class="modal-error" style="margin-bottom: 1rem;">
        <strong i18n:translate="label_warning">Warning:</strong> <span i18n:translate="modal_delete_warning">This action cannot be undone!</span>
      </div>
      <p><strong i18n:translate="label_title">Title:</strong> <span id="delete-modal-title"></span></p>
      <p><strong i18n:translate="label_original_path">Original Path:</strong> <span id="delete-modal-path"></span></p>
    </div>
    <div id="delete-modal-message"></div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeModal('delete')" i18n:translate="button_cancel">Cancel</button>
      <button type="button" class="btn btn-delete" id="delete-modal-confirm-btn" onclick="confirmDelete()" i18n:translate="button_delete_permanently">Delete permanently</button>
    </div>
  </div>

  <!-- Feature Toggle Warning Modal -->
  <div id="toggle-modal-backdrop" class="modal-backdrop"></div>
  <div id="toggle-modal" class="modal-dialog">
    <div class="modal-header">
      <h3 i18n:translate="modal_cannot_disable">Feature cannot be disabled</h3>
    </div>
    <div class="modal-body">
      <div class="modal-warning">
        <strong i18n:translate="modal_pending_deletions_active">There are still pending deletions active.</strong>
        <p style="margin-bottom: 0; margin-top: 0.5rem;" i18n:translate="modal_resolve_to_disable">Resolve these to disable the feature.</p>
      </div>
      <p><span i18n:translate="label_pending_count">Number of pending deletions:</span> <strong id="toggle-pending-count"></strong></p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-primary" onclick="closeModal('toggle')" i18n:translate="button_understood">Understood</button>
    </div>
  </div>

  <!-- Settings Section -->
  <div class="settings-section">
    <h2><span i18n:translate="heading_feature_settings">Feature Settings</span>
      <span tal:condition="feature_enabled" class="feature-status enabled" i18n:translate="status_enabled">Enabled</span>
      <span tal:condition="not: feature_enabled" class="feature-status disabled" i18n:translate="status_disabled">Disabled</span>
    </h2>
    <p i18n:translate="feature_description">When enabled, deleted content will be moved to a special container instead of being permanently deleted.</p>
    <div class="radio-group">
      <label tal:attributes="class python: 'selected' if feature_enabled else ''">
        <input type="radio" name="feature_enabled" value="true"
           tal:attributes="checked python: 'checked' if feature_enabled else None"
               onchange="toggleFeature(true)" />
        <span i18n:translate="status_enabled">Enabled</span>
      </label>
      <label tal:attributes="class python: 'selected' if not feature_enabled else ''">
        <input type="radio" name="feature_enabled" value="false"
           tal:attributes="checked python: 'checked' if not feature_enabled else None"
               onchange="toggleFeature(false)" />
        <span i18n:translate="status_disabled">Disabled</span>
      </label>
    </div>
  </div>

  <!-- Pending Deletions Section -->
  <div class="gdpr-section" tal:condition="feature_enabled">
    <h2 i18n:translate="heading_pending_deletions">Current Deletion Requests (Pending)</h2>
    <table class="pat-datatables listing table table-striped table-hover"
           data-pat-datatables='{
              "columnDefs": [{ "orderable": false, "targets": [8] }],
              "pageLength": 10,
              "order": [[ 4, "desc" ]]}'>
      <thead>
        <tr>
          <th i18n:translate="table_header_title">Title</th>
          <th i18n:translate="table_header_portal_type">Portal Type</th>
          <th i18n:translate="table_header_original_path">Original Path</th>
          <th i18n:translate="table_header_deleted_by">Deleted by</th>
          <th i18n:translate="table_header_deleted_at">Deleted at</th>
          <th i18n:translate="table_header_scheduled_deletion">Scheduled deletion</th>
          <th i18n:translate="table_header_subobjects">Subobjects</th>
          <th i18n:translate="table_header_review_state">Review State</th>
          <th i18n:translate="table_header_actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr tal:repeat="entry python: view.get_pending_entries()">
          <td tal:content="entry/title">Title</td>
          <td tal:content="entry/portal_type">Portal Type</td>
          <td tal:content="entry/original_path">Path</td>
          <td tal:content="entry/user_id">User ID</td>
          <td tal:attributes="data-order entry/datetime" tal:content="python: view.format_datetime(entry.get('datetime'))">Date</td>
          <td tal:content="python: view.get_scheduled_deletion_date(entry.get('datetime'))">Scheduled</td>
          <td tal:content="entry/subobject_count">0</td>
          <td tal:content="entry/review_state">Status</td>
          <td>
            <div class="action-buttons">
              <button type="button"
                      class="btn btn-sm btn-withdraw"
                 tal:attributes="onclick string:showWithdrawModal('${entry/uid}', '${entry/title}', '${entry/original_path}')"
                      i18n:translate="button_withdraw">
                Withdraw
              </button>
              <button type="button"
                      class="btn btn-sm btn-delete"
                 tal:attributes="onclick string:showDeleteModal('${entry/uid}', '${entry/title}', '${entry/original_path}')"
                      i18n:translate="button_delete">
                Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Feature Disabled Notice -->
  <div class="gdpr-section" tal:condition="not: feature_enabled">
    <div class="modal-warning" style="margin: 0;">
      <strong i18n:translate="notice_feature_disabled">The feature is disabled.</strong>
      <p style="margin-bottom: 0; margin-top: 0.5rem;" i18n:translate="notice_enable_feature">Enable the feature to manage deletion requests.</p>
    </div>
  </div>

  <!-- Deletion Log Section -->
  <div class="gdpr-section">
    <h2 i18n:translate="heading_deletion_log">Deletion Log</h2>
    <p class="info-text" i18n:translate="info_log_display_days">Shows entries from the last <span i18n:name="days" tal:replace="display_days">90</span> days. Older entries are still stored in the registry.</p>
    <table class="pat-datatables listing table table-striped table-hover"
           data-pat-datatables='{
              "pageLength": 25,
              "order": [[ 4, "desc" ]]}'>
      <thead>
        <tr>
          <th i18n:translate="table_header_title">Title</th>
          <th i18n:translate="table_header_portal_type">Portal Type</th>
          <th i18n:translate="table_header_original_path">Original Path</th>
          <th i18n:translate="table_header_deleted_by">Deleted by</th>
          <th i18n:translate="table_header_deleted_at">Deleted at</th>
          <th i18n:translate="table_header_status_changed">Status changed</th>
          <th i18n:translate="table_header_changed_by">Changed by</th>
          <th i18n:translate="table_header_status">Status</th>
        </tr>
      </thead>
      <tbody>
        <tr tal:repeat="entry python: view.get_deletion_log_for_display()">
          <td tal:content="entry/title">Title</td>
          <td tal:content="entry/portal_type">Portal Type</td>
          <td tal:content="entry/original_path">Path</td>
          <td tal:content="entry/user_id">User ID</td>
          <td tal:attributes="data-order entry/datetime" tal:content="python: view.format_datetime(entry.get('datetime'))">Submitted</td>
          <td tal:attributes="data-order entry/status_changed" tal:content="python: view.format_datetime(entry.get('status_changed'))">Status changed</td>
          <td tal:content="entry/status_changed_by | nothing">Changed by</td>
          <td>
            <span tal:condition="python: entry.get('status') == 'pending'" class="status-pending" i18n:translate="status_pending">Pending</span>
            <span tal:condition="python: entry.get('status') == 'deleted'" class="status-deleted" i18n:translate="status_deleted">Deleted</span>
            <span tal:condition="python: entry.get('status') == 'withdrawn'" class="status-withdrawn" i18n:translate="status_withdrawn">Withdrawn</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    var currentUid = null;
    var currentAction = null;
    var pendingCount = ${pending_count};

    function showWithdrawModal(uid, title, path) {
      currentAction = 'withdraw';
      currentUid = uid;
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-path').textContent = path;
      document.getElementById('modal-message').innerHTML = '';
      document.getElementById('modal-confirm-btn').disabled = false;
      document.getElementById('modal-confirm-btn').textContent = 'Withdraw';
      document.getElementById('withdraw-modal').classList.add('active');
      document.getElementById('withdraw-modal-backdrop').classList.add('active');
    }

    function showDeleteModal(uid, title, path) {
      currentAction = 'delete';
      currentUid = uid;
      document.getElementById('delete-modal-title').textContent = title;
      document.getElementById('delete-modal-path').textContent = path;
      document.getElementById('delete-modal-message').innerHTML = '';
      document.getElementById('delete-modal-confirm-btn').disabled = false;
      document.getElementById('delete-modal-confirm-btn').textContent = 'Delete permanently';
      document.getElementById('delete-modal').classList.add('active');
      document.getElementById('delete-modal-backdrop').classList.add('active');
    }

    function closeModal(type) {
      if (type === 'withdraw') {
        document.getElementById('withdraw-modal').classList.remove('active');
        document.getElementById('withdraw-modal-backdrop').classList.remove('active');
        currentUid = null;
        currentAction = null;
      } else if (type === 'delete') {
        document.getElementById('delete-modal').classList.remove('active');
        document.getElementById('delete-modal-backdrop').classList.remove('active');
        currentUid = null;
        currentAction = null;
      } else if (type === 'toggle') {
        document.getElementById('toggle-modal').classList.remove('active');
        document.getElementById('toggle-modal-backdrop').classList.remove('active');
        // Reset radio buttons to current state
        var enabledRadio = document.querySelector('input[name=feature_enabled][value=true]');
        var disabledRadio = document.querySelector('input[name=feature_enabled][value=false]');
        if (pendingCount > 0) {
          enabledRadio.checked = true;
          disabledRadio.checked = false;
          updateRadioLabels();
        }
      }
    }

    function updateRadioLabels() {
      var labels = document.querySelectorAll('.radio-group label');
      labels.forEach(function (label) {
        var radio = label.querySelector('input[type=radio]');
        if (radio.checked) {
          label.classList.add('selected');
        } else {
          label.classList.remove('selected');
        }
      });
    }

    function toggleFeature(enable) {
      updateRadioLabels();

      // If trying to disable and there are pending deletions, show warning modal
      if (!enable && pendingCount > 0) {
        document.getElementById('toggle-pending-count').textContent = pendingCount;
        document.getElementById('toggle-modal').classList.add('active');
        document.getElementById('toggle-modal-backdrop').classList.add('active');
        return;
      }

      // Make API call to toggle feature
      var portalUrl = document.body.dataset.portalUrl || '';
      var url = portalUrl + '/@gdpr-settings';

      fetch(url, {
        method: 'PATCH',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ marked_deletion_enabled: enable })
      })
        .then(function (response) {
          return response.json().then(function (data) {
            return { status: response.status, data: data };
          });
        })
        .then(function (result) {
          if (result.status === 200) {
            window.location.reload();
          } else if (result.status === 409) {
            // Show warning modal
            document.getElementById(
              'toggle-pending-count').textContent = result.data.error.pending_count || pendingCount;
            document.getElementById('toggle-modal').classList.add('active');
            document.getElementById('toggle-modal-backdrop').classList.add('active');
          } else {
            alert('Error: ' + (result.data.error ? result.data.error.message : 'Unknown error'));
            window.location.reload();
          }
        })
        .catch(function (error) {
          alert('Error: ' + error.message);
          window.location.reload();
        });
    }

    function confirmWithdraw() {
      if (!currentUid) {
        return;
      }

      var confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Processing...';

      var portalUrl = document.body.dataset.portalUrl || '';
      var url = portalUrl + '/@gdpr-withdraw-deletion/' + currentUid;

      fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
        .then(function (response) {
          return response.json().then(function (data) {
            return { status: response.status, data: data };
          });
        })
        .then(function (result) {
          var messageDiv = document.getElementById('modal-message');

          if (result.status === 200) {
            messageDiv.innerHTML = '<div class=\"modal-success\">' +
                                   '<strong>Success!</strong> ' + result.data.message +
                                   '<br>Restored to: ' + result.data.restored_path +
                                   '</div>';

            setTimeout(function () {
              window.location.reload();
            }, 2000);
          } else if (result.status === 409) {
            messageDiv.innerHTML = '<div class=\"modal-error\">' +
                                   '<strong>Name conflict!</strong><br>' + result.data.error.message +
                                   '</div>';
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Withdraw';
          } else {
            messageDiv.innerHTML = '<div class=\"modal-error\">' +
                                   '<strong>Error!</strong><br>' + (result.data.error ? result.data.error.message : 'Unknown error') +
                                   '</div>';
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Withdraw';
          }
        })
        .catch(function (error) {
          document.getElementById('modal-message').innerHTML = '<div class=\"modal-error\">' +
                                                               '<strong>Error!</strong><br>' + error.message +
                                                               '</div>';
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Withdraw';
        });
    }

    function confirmDelete() {
      if (!currentUid) {
        return;
      }

      var confirmBtn = document.getElementById('delete-modal-confirm-btn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Deleting...';

      var portalUrl = document.body.dataset.portalUrl || '';
      var url = portalUrl + '/@gdpr-permanent-deletion/' + currentUid;

      fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
        .then(function (response) {
          return response.json().then(function (data) {
            return { status: response.status, data: data };
          });
        })
        .then(function (result) {
          var messageDiv = document.getElementById('delete-modal-message');

          if (result.status === 200) {
            messageDiv.innerHTML = '<div class=\"modal-success\">' +
                                   '<strong>Success!</strong> ' + result.data.message +
                                   '</div>';

            setTimeout(function () {
              window.location.reload();
            }, 2000);
          } else {
            messageDiv.innerHTML = '<div class=\"modal-error\">' +
                                   '<strong>Error!</strong><br>' + (result.data.error ? result.data.error.message : 'Unknown error') +
                                   '</div>';
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Delete permanently';
          }
        })
        .catch(function (error) {
          document.getElementById('delete-modal-message').innerHTML = '<div class=\"modal-error\">' +
                                                                       '<strong>Error!</strong><br>' + error.message +
                                                                       '</div>';
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Delete permanently';
        });
    }

    // Close modals on backdrop click
    document.getElementById('withdraw-modal-backdrop').addEventListener('click', function () {
      closeModal('withdraw');
    });
    document.getElementById('delete-modal-backdrop').addEventListener('click', function () {
      closeModal('delete');
    });
    document.getElementById('toggle-modal-backdrop').addEventListener('click', function () {
      closeModal('toggle');
    });

    // Prevent clicks inside modal dialogs from closing the modal
    document.getElementById('withdraw-modal').addEventListener('click', function (e) {
      e.stopPropagation();
    });
    document.getElementById('delete-modal').addEventListener('click', function (e) {
      e.stopPropagation();
    });
    document.getElementById('toggle-modal').addEventListener('click', function (e) {
      e.stopPropagation();
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        closeModal('withdraw');
        closeModal('delete');
        closeModal('toggle');
      }
    });
  </script>

</metal:content-core>

</body>
</html>
