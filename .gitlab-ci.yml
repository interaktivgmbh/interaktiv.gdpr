image: python:3.11-bookworm

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONWARNINGS: "ignore::DeprecationWarning"

cache:
  paths:
    - .cache/pip
  key: ${CI_JOB_IMAGE}

stages:
  - lint
  - test

# Linting & Code Quality
lint:
  stage: lint
  before_script:
    - pip install --upgrade pip
    - pip install ruff
  script:
    - echo "Running ruff linter..."
    - ruff check src/
  allow_failure: true

# Translation Check
translations:
  stage: lint
  before_script:
    - pip install --upgrade pip
    - pip install zest.pocompile
  script:
    - echo "Compiling translations..."
    - pocompile src/
  allow_failure: true

# Main Test Job
test:
  stage: test
  before_script:
    - echo "Installing system dependencies..."
    - apt-get update && apt-get install -y --no-install-recommends
        build-essential
        libxml2-dev
        libxslt1-dev
        libjpeg-dev
        libopenjp2-7-dev
        zlib1g-dev
        git
    - echo "Installing Plone requirements..."
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt
    - echo "Installing test tools..."
    - pip install zope.testrunner
    - echo "Installing interaktiv.framework..."
    - pip install git+https://code.interaktiv.de/interaktiv/interaktiv.framework.git@v14.0.2
    - echo "Installing package..."
    - pip install ".[test]"
  script:
    - echo "Running tests..."
    - SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
    - zope-testrunner --test-path=$SITE_PACKAGES -s interaktiv.gdpr -v
